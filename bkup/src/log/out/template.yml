#file: noinspection YamlFormatViolation

AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Metadata:
  AWS::ServerlessRepo::Application:
    Name: mytiki-lagoon-log
    Description: Sub-component of the mytiki.com Lagoon application. Deploys the Lagoon log component.
    Author: mytiki
    SpdxLicenseId: AGPL-3.0-or-later
    LicenseUrl: ../../../LICENSE
    ReadmeUrl: ../../../README.md
    HomePageUrl: https://mytiki.com
    SemanticVersion: 0.3.6
    SourceCodeUrl: https://github.com/mytiki/lagoon
    Labels:
      - lagoon
      - mytiki
      - component
Resources:
  LogQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref LogQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub arn:aws:sts:${AWS::Region}:${AWS::AccountId}:assumed-role/mytiki-lagoon-prepare*
            Action: SQS:SendMessage
            Resource: !GetAtt LogQueue.Arn
  LogQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: mytiki-lagoon-log.fifo
      ContentBasedDeduplication: true
      DeduplicationScope: messageGroup
      FifoQueue: true
      FifoThroughputLimit: perMessageGroupId
      MessageRetentionPeriod: 604800
      RedriveAllowPolicy:
        redrivePermission: byQueue
        sourceQueueArns:
          - !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:mytiki-lagoon-write.fifo
          - !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:mytiki-lagoon-prepare.fifo
Outputs:
  LogQueue:
    Description: The ARN for the logging message queue
    Value: !GetAtt LogQueue.Arn
